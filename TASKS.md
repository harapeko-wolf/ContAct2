# 管理画面改善タスク

## 問題と要求事項

### 1. ダッシュボード問題修正 ⚠️ URGENT
- **問題**: `http://localhost/admin/dashboard` で興味度の回答の円の色が変わらない（データ不良）
- **原因分析必要**: フィードバックデータの `feedback_type` が期待される値と異なる可能性
- **対応**: 
  - データベースの実際の `feedback_type` 値を確認
  - フロントエンドの色マッピング関数を実際のデータに合わせて修正

### 2. 会社一覧にスコア表示機能追加 ✨ NEW FEATURE
- **要求**: `http://localhost/admin/companies` の会社一覧にスコア（興味度平均など）を表示
- **対応**:
  - バックエンド: 会社ごとのスコア計算API追加
  - フロントエンド: スコア表示列を追加

### 3. スコア順ソート機能追加 ✨ NEW FEATURE
- **要求**: スコアの良い順にソートできる機能
- **対応**:
  - バックエンド: ソートパラメータ対応
  - フロントエンド: ソート機能UI追加

### 4. エンゲージメントスコアリング設定適用 🔧 CONFIGURATION
- **問題**: `http://localhost/admin/settings` のエンゲージメントスコアリング設定が適用されていない
- **対応**:
  - ダッシュボードAPIに設定データ取得機能追加
  - 設定されたアンケート選択肢に基づく色マッピング・テキスト表示

### 5. PDF閲覧エンゲージメントスコア統合 📈 INTEGRATION
- **問題**: `http://localhost/admin/companies` でアンケートスコアのみ表示、PDF閲覧による加算が反映されていない
- **対応**:
  - PDF閲覧時間ベースのスコア計算機能実装
  - 完了ボーナス機能実装
  - アンケートスコア + エンゲージメントスコアの統合

## タスク実行順序

### Phase 1: 問題調査・修正
- [x] **Task 1.1**: ダッシュボードデータ調査
  - DocumentFeedbackテーブルの実際のデータ確認
  - feedback_typeの実際の値を確認
  
- [x] **Task 1.2**: ダッシュボード色表示修正
  - 実際のfeedback_typeに基づいて色マッピング関数修正
  - 新しいスコアベースの色表示対応

### Phase 2: スコア機能追加
- [x] **Task 2.1**: スコア計算バックエンドAPI開発
  - 会社ごとの平均スコア計算
  - 会社一覧APIにスコア情報追加
  
- [x] **Task 2.2**: 会社一覧フロントエンド改修
  - スコア表示列追加
  - スコア順ソート機能追加

### Phase 3: 設定データ適用
- [x] **Task 3.1**: ダッシュボードAPI拡張
  - 設定データ取得機能追加
  - アンケート設定の統合

- [x] **Task 3.2**: 動的スコア表示実装
  - 設定に基づく色マッピング
  - 設定に基づくテキスト表示

### Phase 4: エンゲージメントスコア統合
- [x] **Task 4.1**: PDF閲覧スコア計算実装
  - DocumentViewテーブルからの閲覧時間データ取得
  - 時間層ベースのスコア計算機能
  - 完了ボーナス判定機能

- [x] **Task 4.2**: 総合スコア統合機能
  - アンケートスコア + エンゲージメントスコア統合
  - Company型にengagement_score・survey_scoreフィールド追加
  - 会社一覧ページにスコア内訳表示追加

### Phase 5: 動作確認・テスト
- [ ] **Task 5.1**: 統合テスト
  - ダッシュボード表示確認
  - 会社一覧のスコア表示・ソート確認
  - 設定画面での変更がダッシュボードに反映されることを確認
  
- [ ] **Task 5.2**: PDF閲覧スコア確認
  - PDF閲覧後のエンゲージメントスコア加算確認
  - 時間層による適切なポイント付与確認
  - 完了ボーナスの正常動作確認

## 実装済み機能

### ✅ ダッシュボード修正
- metadata・contentからスコア抽出機能実装
- 新旧両方のフィードバック形式対応
- スコアベース色分け表示（90点以上: 濃緑、75点以上: 緑、50点以上: 黄、25点以上: オレンジ、25点未満: 赤）

### ✅ 会社一覧機能拡張
- スコア・フィードバック数表示
- エンゲージメントスコアプログレスバー
- 複数軸ソート機能（作成日時、名前、スコア、フィードバック数）
- ページネーション対応

### ✅ バックエンドAPI
- MySQL JSON関数使用のスコア計算
- 新旧metadata形式対応
- CompanyController大幅拡張
- DashboardController設定データ統合

### ✅ 設定データ適用
- ダッシュボードAPIに`survey_settings`追加
- 設定された選択肢に基づく動的色マッピング
- 設定された選択肢に基づく動的テキスト表示
- 設定API・ダッシュボードAPIのキー統一

### ✅ PDF閲覧エンゲージメントスコア統合
- DocumentViewからの閲覧時間データ取得
- 設定ベースの時間層スコア計算（10秒→1点、30秒→3点、60秒→5点）
- 完了ボーナス機能（ドキュメント最終ページまで閲覧）
- 総合スコア計算（アンケートスコア + エンゲージメントスコア、上限100点）
- フロントエンドにスコア内訳表示（アンケート/閲覧時間）

## 技術実装詳細

### スコア計算方式
1. **アンケートスコア**: DocumentFeedbackのmetadataから抽出
2. **エンゲージメントスコア**: DocumentViewの閲覧時間から計算
   - 最小閲覧時間: 5秒（設定可能）
   - 時間層ポイント: 10秒→1点、30秒→3点、60秒→5点（設定可能）
   - 完了ボーナス: 20点（設定可能）
3. **総合スコア**: アンケートスコアをベースとしてエンゲージメントスコアを加算（上限100点）

### 設定統合
- `scoring.time_threshold`: 最小閲覧時間
- `scoring.completion_bonus`: 完了ボーナス
- `scoring.tiers`: 時間層とポイント設定

## 次のアクション
1. ブラウザで会社一覧表示確認
2. PDF閲覧後のスコア変動確認
3. 設定画面でスコアリング設定変更後の反映確認

---
**作成日**: 2025年1月27日
**更新日**: 2025年1月27日
**優先度**: High (ダッシュボード修正), Medium (新機能追加), High (設定適用), High (エンゲージメントスコア統合) 